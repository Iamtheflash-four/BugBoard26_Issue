package service;

import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.QueryParam;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;

import java.util.ArrayList;

import com.auth0.jwt.exceptions.JWTVerificationException;
import com.auth0.jwt.exceptions.TokenExpiredException;

import dao.IssuePostgresDAO;
import dto.IssueDTO;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.HeaderParam;


@Path("/issue")
public class FiltraIssuePerPriorita {
    
    @Path("/filtraPriorita")
    @GET
    @Produces(MediaType.APPLICATION_JSON)
    public Response filtraIssuePerPrioritaRequest(
            @HeaderParam("Token") String token,
            @QueryParam("priorita") String priorita) {
        
        try {
            int idUtente = new TokenGenerator(System.getenv("JWT_SECRET"))
                    .validateUserTokenAndGetID(token);
            
            ArrayList<IssueDTO> elencoIssue;
            
            if (priorita == null || priorita.equals("Tutte") || priorita.isEmpty()) 
            {
                elencoIssue = new IssuePostgresDAO().getIssueAssegnateByUser(idUtente);
            } else 
            {
                // Filtra per priorit√† specifica
                elencoIssue = new IssuePostgresDAO()
                        .getIssueAssegnateByUserAndPriority(idUtente, priorita);
            }
            
            return Response.status(Response.Status.OK)
                    .entity(elencoIssue).build();
            
        } catch (TokenExpiredException e) {
            return Response.status(Response.Status.UNAUTHORIZED)
                    .entity("Token scaduto").build();
        } catch (JWTVerificationException e) {
            return Response.status(Response.Status.UNAUTHORIZED)
                    .entity("Token non valido").build();
        } catch (Exception e) {
            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)
                    .entity(e.getMessage()).build();
        }
    }
}
